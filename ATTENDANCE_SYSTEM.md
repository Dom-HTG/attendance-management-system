# QR Code Attendance System Documentation

## Overview

This document describes the QR Code-based attendance system for the Attendance Management Platform. The system allows lecturers to generate unique QR codes for class sessions, which students can scan to automatically mark themselves as present.

**Table of Contents**
- [System Architecture](#system-architecture)
- [Key Features](#key-features)
- [API Endpoints](#api-endpoints)
- [Usage Flow](#usage-flow)
- [Database Schema](#database-schema)
- [Request/Response Examples](#requestresponse-examples)
- [Security Considerations](#security-considerations)
- [Error Handling](#error-handling)
- [Testing Guide](#testing-guide)

---

## System Architecture

### Components

1. **Attendance Domain** (`internal/attendance/domain/attendance.go`)
   - DTOs for requests and responses
   - Data structures for QR code generation and scanning

2. **Attendance Repository** (`internal/attendance/repository/attendance.repository.go`)
   - Database operations for events and attendance records
   - Query methods for retrieving attendance data

3. **Attendance Service** (`internal/attendance/service/attendance.service.go`)
   - Business logic for QR code generation and student check-in
   - Integration with authentication for role-based access

4. **QR Code Utility** (`pkg/utils/qrcode.go`)
   - QR code generation using the `go-qrcode` library
   - Base64 encoding for easy transmission

5. **Auth Middleware** (`pkg/middleware/auth.middleware.go`)
   - JWT token validation
   - Role-based access control
   - Context extraction for user information

### Architecture Diagram

```
┌─────────────────────────────────────────────────────────┐
│                    API Client                           │
│                (Lecturer/Student)                       │
└────────────────────┬────────────────────────────────────┘
                     │
        ┌────────────┴────────────┐
        │                         │
        ▼                         ▼
┌───────────────────┐   ┌──────────────────┐
│  Lecturer Route   │   │  Attendance Route│
│ /qrcode/generate  │   │   /check-in      │
└────────┬──────────┘   └────────┬─────────┘
         │                       │
         ▼                       ▼
┌─────────────────────────────────────────┐
│        Auth Middleware                  │
│   - Validate JWT Token                  │
│   - Extract User Info                   │
│   - Role-based Access Control           │
└────────────┬────────────────────────────┘
             │
    ┌────────┴────────┐
    ▼                 ▼
┌──────────────┐  ┌──────────────────┐
│  QR Service  │  │  QR Utility      │
│              │  │  - Generate      │
│ - Generate   │  │  - Encode        │
│ - Check-in   │  │  - Validate      │
│ - Retrieve   │  │  - Decode        │
└──────┬───────┘  └──────────────────┘
       │
       ▼
┌─────────────────────────────────────┐
│    Attendance Repository            │
│  - CreateEvent                      │
│  - GetEventByQRToken                │
│  - CreateAttendanceRecord           │
│  - GetAttendanceByEventID           │
│  - GetStudentAttendance             │
└────────┬────────────────────────────┘
         │
         ▼
    ┌──────────────┐
    │  PostgreSQL  │
    │  Database    │
    │  - Events    │
    │  - Attendance│
    └──────────────┘
```

---

## Key Features

### 1. QR Code Generation (Lecturer)
- Lecturers create a class session with start/end times, venue, and course details
- System generates a unique QR token and encodes it as a QR code
- QR code is returned as base64-encoded PNG image
- Includes course information in response

### 2. Student Check-in (Student)
- Students scan the QR code generated by the lecturer
- System validates the QR token and retrieves the associated event
- Checks if the event is currently active (between start and end times)
- Prevents duplicate attendance marking
- Records attendance with timestamp

### 3. Attendance Records (Lecturer)
- Lecturers can retrieve all attendance records for a specific event
- Includes student details and check-in times
- Can export or analyze attendance data

### 4. Student Attendance History (Student)
- Students can view their attendance history
- Shows all events they've attended with timestamps
- Helps students track their attendance

---

## API Endpoints

### 1. Generate QR Code (Lecturer Only)

**Endpoint:** `POST /api/lecturer/qrcode/generate`

**Authentication:** Required (JWT Bearer Token)

**Authorization:** Lecturer role required

**Request Body:**
```json
{
  "course_name": "Object-Oriented Programming",
  "course_code": "CS101",
  "start_time": "2025-11-27T10:00:00Z",
  "end_time": "2025-11-27T11:00:00Z",
  "venue": "Room 101, Building A",
  "department": "Computer Science"
}
```

**Response (201 Created):**
```json
{
  "message": "QR code generated successfully",
  "event_id": 1,
  "qr_token": "550e8400-e29b-41d4-a716-446655440000",
  "qr_code": "iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAIAAADTED4xAAACg0lEQVR4nO3YwQmDQBCG4S9Ep7bRBzwOF3sCZ2DLKnQFvQ7fRIXAQAhcKRwI+ON/wh8GXgAA4D/zXQAAXk0AlhOA5QRgOQFYTgCWE4DlBGA5AVhOAJYTgOUEYDkBWE4AlhOA5QRgOQFYTgCWE4DlBGA5AVhOAJYTgOUEYDkBWE4AlhOA5QRgOQFYTgCWE4DlBGA5AVhOAJYTgOUEYDkBWE4AlhOA5QRgOQFYTgCWE4DlBGA5AVhOAJYTgOUEYDkBWE4AlhOA5QRgOQFYTgCWE4DlBGA5AVhOAJYTgOUEYDkBWE4AlhOA5QRgOQFYTgCWE4DlBGA5AVhOAJYTgOUEYDkBWE4AlhOA5QRgOQFYTgCWE4DlBGA5AVhOAJYTgOUEYDkBWE4AlhOA5QRgOQFYTgCWE4DlBGA5AVhOAJYTgOUEYDkBWE4AlhOA5QRgOQFYTgCWE4DlBGA5AVhOAJYTgOUEYDkBWE4AlhOA5QRgOQFYTgCWE4DlBGA5AVhOAJYTgOUEYDkBWE4AlhOA5QRgOQFYTgCWE4DlBGA5AVhOAJYTgOUEYDkBWE4AlhOA5QRgOQFYTgCWE4DlBGA5AVhOAJYTgOUEYDkBWE4AlhOA5QRgOQFYTgCWE4DlBGA5AVhOAJYTgOUEYDkBWE4AlhOA5QRgOQFYTgCWE4DlBGA5AVhOAJYTgOUEYDkBWE4AlhOA5QRgOQFYTgCWE4DlBGA5AVhOAJYTgOUEYDkBWE4AlhOA5QRgOQFYTgCWE4DlBGA5AVhOAJYTgOUEYDkBWE4AlhOA5QRgOQFYTgCWE4DlBGA5AVhOAJYTgOUEYDkBWE4AlhOA5QRgOQFYTgCWE4DlBGA5AVhOAJYTgOUEYDkBWG4EVDwCTd/LqvEAAAAASUVORK5CYII=",
  "course_name": "Object-Oriented Programming",
  "course_code": "CS101",
  "start_time": "2025-11-27T10:00:00Z",
  "end_time": "2025-11-27T11:00:00Z",
  "venue": "Room 101, Building A",
  "department": "Computer Science",
  "created_by": "John Doe",
  "created_at": "2025-11-27T09:30:00Z",
  "expires_at": "2025-11-27T11:00:00Z"
}
```

**Error Responses:**
- `400 Bad Request` - Invalid request body or date format
- `401 Unauthorized` - Missing or invalid JWT token
- `403 Forbidden` - User is not a lecturer
- `500 Internal Server Error` - Database error

---

### 2. Student Check-in (Student Only)

**Endpoint:** `POST /api/attendance/check-in`

**Authentication:** Required (JWT Bearer Token)

**Authorization:** Student role required

**Request Body:**
```json
{
  "qr_token": "550e8400-e29b-41d4-a716-446655440000"
}
```

**Response (200 OK):**
```json
{
  "message": "Check-in successful",
  "status": "present",
  "student_id": 5,
  "student_name": "Jane Smith",
  "matric_number": "STU-2024-005",
  "course_name": "Object-Oriented Programming (CS101)",
  "course_code": "CS101",
  "marked_time": "2025-11-27T10:15:30Z"
}
```

**Error Responses:**
- `400 Bad Request` - Invalid or missing QR token
- `401 Unauthorized` - Missing or invalid JWT token
- `403 Forbidden` - User is not a student
- `404 Not Found` - Invalid QR code or event not found
- `409 Conflict` - Student already checked in for this event
- `500 Internal Server Error` - Database error

---

### 3. Get Event Attendance Records (Lecturer Only)

**Endpoint:** `GET /api/attendance/:event_id`

**Authentication:** Required (JWT Bearer Token)

**Authorization:** Lecturer role required

**Response (200 OK):**
```json
{
  "message": "Attendance records retrieved successfully",
  "event_id": 1,
  "course_name": "Object-Oriented Programming (CS101)",
  "course_code": "CS101",
  "department": "Computer Science",
  "start_time": "2025-11-27T10:00:00Z",
  "end_time": "2025-11-27T11:00:00Z",
  "venue": "Room 101, Building A",
  "created_by": "John Doe",
  "total_present": 2,
  "attendance_records": [
    {
      "id": 1,
      "student_id": 5,
      "student_name": "Jane Smith",
      "matric_number": "STU-2024-005",
      "status": "present",
      "marked_time": "2025-11-27T10:15:30Z"
    },
    {
      "id": 2,
      "student_id": 6,
      "student_name": "John Wilson",
      "matric_number": "STU-2024-006",
      "status": "present",
      "marked_time": "2025-11-27T10:18:45Z"
    }
  ],
  "generated_at": "2025-11-27T11:30:00Z"
}
```

---

### 4. Get Student Attendance History

**Endpoint:** `GET /api/attendance/student/records`

**Authentication:** Required (JWT Bearer Token)

**Authorization:** Student role required

**Response (200 OK):**
```json
{
  "message": "Student attendance records retrieved successfully",
  "student_id": 5,
  "student_name": "Jane Smith",
  "matric_number": "STU-2024-005",
  "total_events": 10,
  "total_present": 8,
  "attendance_records": [
    {
      "id": 1,
      "student_id": 5,
      "student_name": "Jane Smith",
      "matric_number": "STU-2024-005",
      "status": "present",
      "marked_time": "2025-11-27T10:15:30Z"
    }
  ],
  "generated_at": "2025-11-27T11:30:00Z"
}
```

---

## Usage Flow

### Workflow Diagram

```
┌─────────────────────────────────────────────────────────────────┐
│                       START OF CLASS                            │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                  ┌──────────────────────────┐
                  │   Lecturer: Generate QR  │
                  │   POST /qrcode/generate  │
                  └──────────┬───────────────┘
                             │
                             ▼
                  ┌──────────────────────────┐
                  │  System: Create Event    │
                  │  Generate QR Code        │
                  │  Return Base64 Image     │
                  └──────────┬───────────────┘
                             │
                             ▼
                  ┌──────────────────────────┐
                  │  Lecturer: Share QR Code │
                  │  Display on Projector    │
                  │  or Send via Email       │
                  └──────────┬───────────────┘
                             │
        ┌────────────────────┼────────────────────┐
        │                    │                    │
        ▼                    ▼                    ▼
    Student 1            Student 2            Student 3
        │                    │                    │
        └────────────┬───────┴────────┬───────────┘
                     │                │
                     ▼                ▼
          ┌────────────────────────────────┐
          │  Student: Scan QR Code         │
          │  POST /attendance/check-in     │
          └────────────┬───────────────────┘
                       │
                       ▼
          ┌────────────────────────────────┐
          │  System: Validate QR Token     │
          │  - Check event is active       │
          │  - Prevent duplicates          │
          │  - Record with timestamp       │
          └────────────┬───────────────────┘
                       │
                       ▼
          ┌────────────────────────────────┐
          │  Database: Create Attendance   │
          │  Record                        │
          └────────────┬───────────────────┘
                       │
                       ▼
          ┌────────────────────────────────┐
          │  System: Return Success        │
          │  Response with Details         │
          └────────────────────────────────┘

         ┌─────────────────────────────────┐
         │    END OF CLASS                 │
         └──────────┬──────────────────────┘
                    │
                    ▼
         ┌────────────────────────────┐
         │  Lecturer: View Attendance │
         │  GET /attendance/:event_id │
         └────────────┬───────────────┘
                      │
                      ▼
         ┌────────────────────────────┐
         │  System: Return all records│
         │  with student details      │
         └────────────────────────────┘
```

### Step-by-Step Process

#### For Lecturers:

1. **Generate QR Code**
   - Call `POST /api/lecturer/qrcode/generate`
   - Provide course details, start/end times, venue
   - Receive base64-encoded QR code and token

2. **Share QR Code**
   - Display QR code on projector or screen
   - Students can scan with their devices

3. **View Attendance**
   - After class ends, call `GET /api/attendance/:event_id`
   - Review all students who checked in
   - Export data if needed

#### For Students:

1. **Scan QR Code**
   - Open mobile app or web interface
   - Point camera at QR code
   - App automatically extracts QR token

2. **Check In**
   - System calls `POST /api/attendance/check-in`
   - Sends QR token to server

3. **Confirmation**
   - Receive success response with attendance details
   - Time of check-in is recorded

---

## Database Schema

### Events Table
```sql
CREATE TABLE events (
  id SERIAL PRIMARY KEY,
  event_name VARCHAR(255) NOT NULL,
  start_time TIMESTAMP NOT NULL,
  end_time TIMESTAMP NOT NULL,
  venue VARCHAR(255),
  qr_code_token VARCHAR(255) UNIQUE NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_qr_token ON events(qr_code_token);
CREATE INDEX idx_start_time ON events(start_time);
```

### Attendance Table
```sql
CREATE TABLE attendances (
  id SERIAL PRIMARY KEY,
  event_id INT NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (event_id) REFERENCES events(id) ON DELETE CASCADE
);

CREATE INDEX idx_event_id ON attendances(event_id);
```

### User Attendance Table
```sql
CREATE TABLE user_attendances (
  id SERIAL PRIMARY KEY,
  attendance_id INT NOT NULL,
  student_id INT NOT NULL,
  status VARCHAR(50) DEFAULT 'present',
  marked_time TIMESTAMP NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (attendance_id) REFERENCES attendances(id) ON DELETE CASCADE,
  FOREIGN KEY (student_id) REFERENCES students(id) ON DELETE CASCADE,
  UNIQUE(attendance_id, student_id)
);

CREATE INDEX idx_attendance_id ON user_attendances(attendance_id);
CREATE INDEX idx_student_id ON user_attendances(student_id);
CREATE INDEX idx_marked_time ON user_attendances(marked_time);
```

---

## Request/Response Examples

### Example 1: Complete QR Code Generation Flow

```bash
# 1. Lecturer logs in
curl -X POST http://localhost:2754/api/auth/login-lecturer \
  -H "Content-Type: application/json" \
  -d '{
    "email": "prof.johndoe@university.edu",
    "password": "SecurePassword123"
  }'

# Response:
{
  "message": "Login successful",
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "user": { ... }
}

# 2. Lecturer generates QR code
curl -X POST http://localhost:2754/api/lecturer/qrcode/generate \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." \
  -d '{
    "course_name": "Object-Oriented Programming",
    "course_code": "CS101",
    "start_time": "2025-11-27T10:00:00Z",
    "end_time": "2025-11-27T11:00:00Z",
    "venue": "Room 101, Building A",
    "department": "Computer Science"
  }'

# Response includes base64 QR code
```

### Example 2: Student Check-In Flow

```bash
# 1. Student logs in
curl -X POST http://localhost:2754/api/auth/login-student \
  -H "Content-Type: application/json" \
  -d '{
    "email": "jane.smith@student.edu",
    "password": "StudentPassword123"
  }'

# Response with JWT token

# 2. Student checks in with QR token
curl -X POST http://localhost:2754/api/attendance/check-in \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." \
  -d '{
    "qr_token": "550e8400-e29b-41d4-a716-446655440000"
  }'

# Response:
{
  "message": "Check-in successful",
  "status": "present",
  "student_id": 5,
  "student_name": "Jane Smith",
  "matric_number": "STU-2024-005",
  "marked_time": "2025-11-27T10:15:30Z"
}
```

### Example 3: Retrieve Attendance Records

```bash
# Lecturer retrieves attendance for event 1
curl -X GET http://localhost:2754/api/attendance/1 \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."

# Response includes all students who checked in
```

---

## Security Considerations

### 1. Authentication & Authorization
- All endpoints require valid JWT tokens
- Role-based access control (RBAC) ensures only authorized users can access endpoints
- Lecturers can only generate QR codes
- Students can only check in to events

### 2. QR Code Security
- QR tokens are UUIDs (v4), ensuring uniqueness and randomness
- Tokens are stored securely in the database
- QR codes are time-limited (valid only during event hours)

### 3. Duplicate Prevention
- Database unique constraint on `(attendance_id, student_id)` prevents duplicate check-ins
- Application-level validation before recording attendance

### 4. Data Validation
- All inputs are validated using Gin binding validators
- Date/time formats are validated using RFC3339
- Email addresses are validated

### 5. SQL Injection Prevention
- Parameterized queries using GORM
- No raw SQL concatenation

### 6. Rate Limiting
- Consider implementing rate limiting for:
  - QR code generation (prevent abuse)
  - Check-in endpoint (prevent spam)

---

## Error Handling

### HTTP Status Codes

| Code | Meaning | Example |
|------|---------|---------|
| 200 OK | Request successful | Check-in successful |
| 201 Created | Resource created | QR code generated |
| 400 Bad Request | Invalid request | Missing required fields |
| 401 Unauthorized | Authentication failed | Invalid/expired token |
| 403 Forbidden | Access denied | Wrong role for endpoint |
| 404 Not Found | Resource not found | Event not found |
| 409 Conflict | Resource conflict | Duplicate check-in |
| 500 Server Error | Server error | Database error |

### Error Response Format

```json
{
  "error": "error message",
  "details": "additional context (if available)"
}
```

---

## Testing Guide

### 1. Setup for Testing

```bash
# Start Docker containers
docker-compose up -d

# Verify services are running
docker-compose ps

# Check logs
docker-compose logs app
```

### 2. Using Postman

1. **Import Postman Collection**
   - Import `postman_collection.json`
   - Select "QR Code Attendance" folder

2. **Setup Authentication**
   - Register a lecturer account
   - Register a student account
   - Login to get JWT tokens
   - Copy tokens to Postman environment

3. **Test QR Generation**
   - Use lecturer JWT token
   - POST to `/api/lecturer/qrcode/generate`
   - Verify QR code is generated
   - Copy QR token from response

4. **Test Student Check-In**
   - Use student JWT token
   - POST to `/api/attendance/check-in`
   - Use QR token from previous step
   - Verify success response

5. **Test Attendance Retrieval**
   - Use lecturer JWT token
   - GET `/api/attendance/:event_id`
   - Verify all check-ins are listed

### 3. Using cURL

```bash
# Register lecturer
curl -X POST http://localhost:2754/api/auth/register-lecturer \
  -H "Content-Type: application/json" \
  -d '{
    "first_name": "John",
    "last_name": "Doe",
    "email": "john@university.edu",
    "password": "TestPassword123",
    "department": "Computer Science",
    "staff_id": "PROF-001"
  }'

# Login lecturer
TOKEN=$(curl -s -X POST http://localhost:2754/api/auth/login-lecturer \
  -H "Content-Type: application/json" \
  -d '{
    "email": "john@university.edu",
    "password": "TestPassword123"
  }' | jq -r '.access_token')

# Generate QR code
curl -X POST http://localhost:2754/api/lecturer/qrcode/generate \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "course_name": "Database Systems",
    "course_code": "CS201",
    "start_time": "2025-11-27T14:00:00Z",
    "end_time": "2025-11-27T15:00:00Z",
    "venue": "Lab 201",
    "department": "Computer Science"
  }'
```

### 4. Testing Scenarios

| Scenario | Steps | Expected Result |
|----------|-------|-----------------|
| Valid QR generation | Lecturer provides valid course details | 201 Created with QR code |
| Invalid date format | Lecturer provides wrong date format | 400 Bad Request |
| End before start | End time before start time | 400 Bad Request |
| Valid check-in | Student scans valid QR during event | 200 OK with attendance record |
| Expired event | Student scans QR after event end | 400 Bad Request |
| Duplicate check-in | Student checks in twice | 409 Conflict |
| Invalid QR token | Student submits invalid token | 404 Not Found |
| Wrong role | Student attempts to generate QR | 403 Forbidden |

---

## Implementation Notes

### Current Limitations

1. **Course Code Storage**
   - Course code is currently part of event name
   - Consider adding separate `course_code` column to Events table

2. **Student Information**
   - Student name and matric number need to be fetched from database
   - Currently uses placeholder values in some responses

3. **Attendance Status**
   - Currently only supports "present" status
   - Consider adding "late", "absent", "excused" statuses

4. **QR Code Expiry**
   - QR codes are valid during event hours
   - Consider adding manual expiry option for early termination

### Recommended Enhancements

1. **Batch Check-In**
   - Allow multiple students to check in simultaneously
   - Implement WebSocket for real-time attendance updates

2. **Attendance Analytics**
   - Generate attendance reports by course, department, student
   - Calculate attendance percentages
   - Identify at-risk students

3. **Offline Mode**
   - Cache QR codes for offline scanning
   - Sync attendance when online

4. **Mobile App**
   - Native mobile app for scanning QR codes
   - Offline QR code storage

5. **Notification System**
   - Notify lecturers of attendance in real-time
   - Alert students of low attendance

6. **Integration with Academic Calendar**
   - Automatic event creation from academic calendar
   - Validation against scheduled courses

---

## Troubleshooting

### QR Code Not Generated

**Issue:** `failed to generate QR code` error

**Solutions:**
- Check go-qrcode library is installed: `go list github.com/skip2/go-qrcode`
- Verify QR token is valid (not empty)
- Check available memory on server

### Check-In Fails

**Issue:** Student gets error when checking in

**Solutions:**
- Verify event is within start/end time
- Check student JWT token is valid
- Confirm student hasn't already checked in
- Verify QR token matches an existing event

### Event Not Found

**Issue:** `event not found` error

**Solutions:**
- Verify event was created successfully
- Check event hasn't been deleted
- Confirm QR token is correct (check database)

---

## Conclusion

The QR Code Attendance System provides a secure, efficient, and scalable solution for marking attendance in educational institutions. It leverages modern technologies like QR codes, JWT authentication, and RESTful APIs to create a seamless experience for both lecturers and students.

For more information, refer to the main README and API documentation.
